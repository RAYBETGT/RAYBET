<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raybet Casino</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js"></script>
    
    <style>
        /* ALL YOUR CSS STAYS THE SAME - NOT CHANGING */
        /* ... (all your existing CSS code) ... */
    </style>
</head>
<body>
    <!-- ALL YOUR HTML STAYS THE SAME - NOT CHANGING -->
    <!-- ... (all your existing HTML code) ... -->

    <script>
        // ============================================
        // ==== FIREBASE CONFIG =======================
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyA6c82EcBedDn78KUmHUCUhMwt5w7lpKjQ",
            authDomain: "raybet-82ea0.firebaseapp.com",
            projectId: "raybet-82ea0",
            storageBucket: "raybet-82ea0.firebasestorage.app",
            messagingSenderId: "851971186704",
            appId: "1:851971186704:web:e20e3581ee97a3a7aeaa95"
        };

        // ============================================
        // ==== ADMIN PASSWORD ========================
        // ============================================
        const ADMIN_PASSWORD = "mado81418093lss";

        // ============================================
        // ==== GLOBAL VARIABLES ======================
        // ============================================
        let db = null;
        let isAdmin = false;
        let timerInterval = null;
        let currentEventEndDate = null;
        let isFirebaseConnected = false;
        let realtimeListener = null;

        // ============================================
        // ==== WHATSAPP AUTO-OPEN FUNCTIONS ==========
        // ============================================
        function openSupportWhatsApp() {
            const phoneNumber = "96181050883";
            const message = "Hello Raybet Support! I have a problem/issue that needs assistance.";
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            
            window.open(whatsappUrl, '_blank');
            console.log("üì± Opening WhatsApp for Support");
        }

        // ============================================
        // ==== INITIALIZATION ========================
        // ============================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log("üöÄ Website Initializing...");
            
            // Start intro animation
            startIntroAnimation();
            
            // Set default values immediately
            setDefaultValues();
            
            // After intro animation completes, try to connect to Firebase
            setTimeout(async () => {
                await initializeFirebase();
            }, 3500);
        });

        // ============================================
        // ==== FIREBASE INITIALIZATION ==============
        // ============================================
        async function initializeFirebase() {
            try {
                console.log("üîÑ Initializing Firebase...");
                
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                // Enable offline persistence
                await db.enablePersistence()
                    .catch((err) => {
                        console.warn("Offline persistence not supported:", err.code);
                    });
                
                console.log("‚úÖ Firebase initialized successfully");
                
                // Test connection by reading data
                await testFirebaseConnection();
                
            } catch (error) {
                console.error("‚ùå Firebase initialization failed:", error);
                handleFirebaseError();
            }
        }

        async function testFirebaseConnection() {
            try {
                console.log("üîÑ Testing Firebase connection...");
                
                // Try to read data with timeout
                const docRef = db.collection('website').doc('config');
                const doc = await Promise.race([
                    docRef.get(),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Connection timeout')), 10000)
                    )
                ]);
                
                isFirebaseConnected = true;
                console.log("‚úÖ Firebase connection successful!");
                
                // Update UI to show online status
                document.getElementById('announcementText').textContent = 
                    "üéâ WELCOME TO RAYBET CASINO! ‚úÖ Live Updates Enabled";
                
                // Load data and setup real-time updates
                await loadWebsiteData();
                setupRealtimeUpdates();
                
            } catch (error) {
                console.warn("‚ö†Ô∏è Firebase connection test failed:", error.message);
                isFirebaseConnected = false;
                
                // Update UI to show offline status
                document.getElementById('announcementText').textContent = 
                    "üéâ WELCOME TO RAYBET CASINO! üì± Local Mode";
                
                // Load from local storage
                loadLocalData();
                startDefaultTimer();
            }
        }

        function handleFirebaseError() {
            isFirebaseConnected = false;
            console.log("üì± Using local storage mode");
            
            // Update UI
            document.getElementById('announcementText').textContent = 
                "üéâ WELCOME TO RAYBET CASINO! üì± Local Mode";
            
            loadLocalData();
            startDefaultTimer();
        }

        // ============================================
        // ==== SET DEFAULT VALUES ===================
        // ============================================
        function setDefaultValues() {
            document.getElementById('announcementText').textContent = 
                "üéâ WELCOME TO RAYBET CASINO!";
            
            document.getElementById('worldName').textContent = "RAYBET";
            document.getElementById('timerTitle').textContent = "üéØ NEXT TOURNAMENT";
            document.getElementById('eventName').textContent = "Tournament Countdown";
            
            startDefaultTimer();
        }

        // ============================================
        // ==== LOAD DATA FROM FIREBASE ==============
        // ============================================
        async function loadWebsiteData() {
            if (!isFirebaseConnected || !db) {
                console.log("Skipping Firebase load - not connected");
                loadLocalData();
                return;
            }
            
            try {
                console.log("üîÑ Loading data from Firebase...");
                const docRef = db.collection('website').doc('config');
                const doc = await docRef.get();
                
                if (doc.exists) {
                    const data = doc.data();
                    console.log("‚úÖ Data loaded from Firebase:", data);
                    
                    // Update UI with Firebase data
                    updateUIFromData(data);
                    
                    // Start timer if event date exists
                    if (data.eventEndDate) {
                        currentEventEndDate = new Date(data.eventEndDate);
                        startTimer();
                    } else {
                        startDefaultTimer();
                    }
                    
                    // Save to local storage as backup
                    saveToLocalStorage(data);
                    
                } else {
                    console.log("No data in Firebase, creating default...");
                    await createDefaultFirebaseData();
                }
            } catch (error) {
                console.error("Error loading from Firebase:", error);
                loadLocalData();
                startDefaultTimer();
            }
        }

        async function createDefaultFirebaseData() {
            if (!isFirebaseConnected || !db) return;
            
            try {
                const defaultData = {
                    announcement: "üéâ WELCOME TO RAYBET CASINO!",
                    worldName: "RAYBET",
                    eventName: "NEXT TOURNAMENT",
                    eventEndDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('website').doc('config').set(defaultData);
                console.log("‚úÖ Default data created in Firebase");
                
                updateUIFromData(defaultData);
                currentEventEndDate = new Date(defaultData.eventEndDate);
                startTimer();
                saveToLocalStorage(defaultData);
                
            } catch (error) {
                console.error("Error creating default Firebase data:", error);
                loadLocalData();
                startDefaultTimer();
            }
        }

        function updateUIFromData(data) {
            if (data.announcement) {
                document.getElementById('announcementText').textContent = data.announcement;
            }
            
            if (data.worldName) {
                document.getElementById('worldName').textContent = data.worldName;
            }
            
            if (data.eventName) {
                document.getElementById('timerTitle').textContent = `üéØ ${data.eventName}`;
                document.getElementById('eventName').textContent = data.eventName;
            }
        }

        // ============================================
        // ==== REALTIME UPDATES =====================
        // ============================================
        function setupRealtimeUpdates() {
            if (!isFirebaseConnected || !db) {
                console.log("Cannot setup realtime updates - Firebase not connected");
                return;
            }
            
            try {
                // Remove existing listener if any
                if (realtimeListener) {
                    realtimeListener();
                }
                
                console.log("üîÑ Setting up real-time updates...");
                
                realtimeListener = db.collection('website').doc('config')
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            const data = doc.data();
                            console.log("üîÑ Real-time update received:", data);
                            
                            // Update UI
                            updateUIFromData(data);
                            
                            // Update timer if date changed
                            if (data.eventEndDate) {
                                const newDate = new Date(data.eventEndDate);
                                if (!currentEventEndDate || newDate.getTime() !== currentEventEndDate.getTime()) {
                                    currentEventEndDate = newDate;
                                    startTimer();
                                }
                            }
                            
                            // Save to local storage as backup
                            saveToLocalStorage(data);
                        }
                    }, (error) => {
                        console.error("‚ùå Realtime listener error:", error);
                        // Try to reconnect after 10 seconds
                        setTimeout(() => {
                            if (isFirebaseConnected) {
                                setupRealtimeUpdates();
                            }
                        }, 10000);
                    });
                
                console.log("‚úÖ Real-time updates enabled");
                
            } catch (error) {
                console.error("Error setting up realtime updates:", error);
            }
        }

        // ============================================
        // ==== UPDATE WEBSITE (ADMIN FUNCTION) ======
        // ============================================
        async function updateWebsite() {
            const announcement = document.getElementById('announcementInput').value.trim();
            const worldName = document.getElementById('worldNameInput').value.trim();
            const eventName = document.getElementById('eventNameInput').value.trim();
            const eventDate = document.getElementById('eventDateInput').value;
            
            // Validation
            if (!announcement || !worldName || !eventName || !eventDate) {
                alert("Please fill all fields");
                return;
            }
            
            const eventDateObj = new Date(eventDate);
            if (eventDateObj <= new Date()) {
                alert("Event date must be in the future!");
                return;
            }
            
            document.getElementById('updateLoading').style.display = 'block';
            hideAllMessages();
            
            try {
                console.log("üîÑ Updating website...");
                
                // Prepare update data
                const updateData = {
                    announcement: announcement,
                    worldName: worldName,
                    eventName: eventName,
                    eventEndDate: eventDateObj.toISOString(),
                    updatedAt: new Date().toISOString(),
                    updatedBy: "admin",
                    timestamp: Date.now()
                };
                
                // 1. Always save to local storage first (immediate backup)
                saveToLocalStorage(updateData);
                console.log("üíæ Saved to local storage");
                
                // 2. Update UI immediately
                document.getElementById('announcementText').textContent = announcement;
                document.getElementById('worldName').textContent = worldName;
                document.getElementById('timerTitle').textContent = `üéØ ${eventName}`;
                document.getElementById('eventName').textContent = eventName;
                currentEventEndDate = eventDateObj;
                startTimer();
                
                // 3. Try to save to Firebase if connected
                let firebaseSuccess = false;
                if (isFirebaseConnected && db) {
                    try {
                        // Add Firebase server timestamp
                        updateData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                        updateData.firebaseUpdated = true;
                        
                        await db.collection('website').doc('config').set(updateData, { merge: true });
                        
                        firebaseSuccess = true;
                        console.log("‚úÖ Data saved to Firebase");
                        
                        // Show success message with Firebase info
                        document.getElementById('updateSuccess').innerHTML = 
                            "‚úÖ Updated for ALL users! <br><small>Real-time updates active</small>";
                        
                    } catch (firebaseError) {
                        console.warn("‚ö†Ô∏è Could not save to Firebase:", firebaseError);
                        
                        // Show warning but still success (local storage saved)
                        document.getElementById('updateSuccess').innerHTML = 
                            "‚úÖ Updated locally! <br><small>Firebase sync failed - check security rules</small>";
                    }
                } else {
                    console.log("üì± Firebase not connected, saving locally only");
                    document.getElementById('updateSuccess').innerHTML = 
                        "‚úÖ Updated locally! <br><small>Firebase offline - changes saved locally</small>";
                }
                
                showMessage('updateSuccess');
                
                // Close panel after 3 seconds
                setTimeout(() => {
                    closeAdminPanel();
                }, 3000);
                
            } catch (error) {
                console.error("Update error:", error);
                document.getElementById('updateError').textContent = 
                    "‚ùå Update failed: " + error.message;
                showMessage('updateError');
            } finally {
                document.getElementById('updateLoading').style.display = 'none';
            }
        }

        // ============================================
        // ==== LOCAL STORAGE FUNCTIONS ==============
        // ============================================
        function saveToLocalStorage(data) {
            try {
                if (data.announcement) {
                    localStorage.setItem('raybetAnnouncement', data.announcement);
                }
                if (data.worldName) {
                    localStorage.setItem('raybetWorldName', data.worldName);
                }
                if (data.eventName) {
                    localStorage.setItem('raybetEventName', data.eventName);
                }
                if (data.eventEndDate) {
                    localStorage.setItem('raybetEventDate', data.eventEndDate);
                }
                console.log("üíæ Data saved to local storage");
            } catch (error) {
                console.warn("Could not save to local storage:", error);
            }
        }

        function loadLocalData() {
            try {
                const localAnnouncement = localStorage.getItem('raybetAnnouncement');
                const localWorldName = localStorage.getItem('raybetWorldName');
                const localEventName = localStorage.getItem('raybetEventName');
                const localEventDate = localStorage.getItem('raybetEventDate');
                
                if (localAnnouncement) {
                    document.getElementById('announcementText').textContent = localAnnouncement;
                }
                if (localWorldName) {
                    document.getElementById('worldName').textContent = localWorldName;
                }
                if (localEventName) {
                    document.getElementById('timerTitle').textContent = `üéØ ${localEventName}`;
                    document.getElementById('eventName').textContent = localEventName;
                }
                if (localEventDate) {
                    currentEventEndDate = new Date(localEventDate);
                    startTimer();
                } else {
                    startDefaultTimer();
                }
                
                console.log("üì± Loaded from local storage");
            } catch (error) {
                console.log("No local data found, using defaults");
            }
        }

        // ============================================
        // ==== TIMER FUNCTIONS ======================
        // ============================================
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                updateTimerDisplay();
            }, 1000);
            
            updateTimerDisplay();
        }

        function startDefaultTimer() {
            currentEventEndDate = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
            startTimer();
        }

        function updateTimerDisplay() {
            if (!currentEventEndDate) return;
            
            const now = new Date();
            const timeRemaining = currentEventEndDate - now;
            
            if (timeRemaining <= 0) {
                document.getElementById('days').textContent = '00';
                document.getElementById('hours').textContent = '00';
                document.getElementById('minutes').textContent = '00';
                document.getElementById('seconds').textContent = '00';
                document.getElementById('eventName').textContent = 'EVENT STARTED! üéâ';
                clearInterval(timerInterval);
                return;
            }
            
            const days = Math.floor(timeRemaining / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeRemaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeRemaining % (1000 * 60)) / 1000);
            
            document.getElementById('days').textContent = days.toString().padStart(2, '0');
            document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
            document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
            document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');
        }

        // ============================================
        // ==== ADMIN FUNCTIONS (REST) ===============
        // ============================================
        // ... (rest of your admin functions remain the same) ...
        function openAdminPanel() {
            document.getElementById('adminPanel').style.display = 'flex';
            
            if (isAdmin) {
                showControlScreen();
            } else {
                showLoginScreen();
            }
        }

        function closeAdminPanel() {
            document.getElementById('adminPanel').style.display = 'none';
            hideAllMessages();
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('controlScreen').style.display = 'none';
            document.getElementById('adminPassword').value = '';
            hideAllMessages();
        }

        function showControlScreen() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('controlScreen').style.display = 'block';
            
            document.getElementById('announcementInput').value = 
                document.getElementById('announcementText').textContent;
            
            document.getElementById('worldNameInput').value = 
                document.getElementById('worldName').textContent;
            
            document.getElementById('eventNameInput').value = 
                document.getElementById('timerTitle').textContent.replace('üéØ ', '');
            
            if (currentEventEndDate) {
                const dateInput = new Date(currentEventEndDate);
                const localDateTime = dateInput.toISOString().slice(0, 16);
                document.getElementById('eventDateInput').value = localDateTime;
            } else {
                const defaultDate = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
                document.getElementById('eventDateInput').value = defaultDate.toISOString().slice(0, 16);
            }
            
            hideAllMessages();
        }

        async function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            
            if (password === ADMIN_PASSWORD) {
                document.getElementById('loginLoading').style.display = 'block';
                
                try {
                    isAdmin = true;
                    showControlScreen();
                    console.log("‚úÖ Admin logged in");
                    
                } catch (error) {
                    console.error("Login error:", error);
                    showMessage('loginError');
                } finally {
                    document.getElementById('loginLoading').style.display = 'none';
                }
            } else {
                showMessage('loginError');
            }
        }

        function logoutAdmin() {
            isAdmin = false;
            closeAdminPanel();
            console.log("üîì Admin logged out");
        }

        // ============================================
        // ==== HELPER FUNCTIONS =====================
        // ============================================
        function showMessage(elementId) {
            hideAllMessages();
            document.getElementById(elementId).style.display = 'block';
        }

        function hideAllMessages() {
            document.querySelectorAll('.message, .loading').forEach(msg => {
                msg.style.display = 'none';
            });
        }

        function startIntroAnimation() {
            const introScreen = document.getElementById('introScreen');
            setTimeout(() => {
                introScreen.style.display = 'none';
            }, 4000);
        }

        // Event Listeners
        document.getElementById('adminPanel').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAdminPanel();
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.altKey && e.key === 'a') {
                e.preventDefault();
                openAdminPanel();
            }
            if (e.key === 'Escape') {
                closeAdminPanel();
            }
        });

        // Debug info
        console.log("üåê Website loaded successfully");
        console.log("üîß Admin password: " + (ADMIN_PASSWORD ? "Set" : "Not set"));
        console.log("üìä Firebase config loaded: " + (firebaseConfig.apiKey ? "Yes" : "No"));
    </script>
</body>
</html>
